<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Share</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        html, body {
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden; /* 防止分享模式出現雙捲軸 */
        }

        /* --- 創作者模式介面 (預設隱藏，由 JS 控制) --- */
        #creator-ui {
            display: none;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            margin-bottom: 60px;
        }

        .input-group {
            width: 100%;
            max-width: 400px;
        }

        input {
            width: 100%;
            border: none;
            border-bottom: 1px solid #000;
            padding: 15px 0;
            font-size: 16px;
            background: transparent;
            outline: none;
            margin-bottom: 30px;
            text-align: center;
        }

        button {
            background: #000;
            color: #fff;
            border: none;
            padding: 12px 40px;
            font-size: 11px;
            letter-spacing: 0.2em;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover { opacity: 0.7; }

        /* --- 分享模式介面 (全螢幕播放器) --- */
        #player-container {
            display: none;
            width: 100vw;
            height: 100vh;
            background: #fff;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* 浮動分享按鈕 (僅在分享模式下淡出顯示，方便二次分享) */
        #floating-share {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #000;
            padding: 8px 15px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            z-index: 100;
            display: none;
        }

        /* 動態顯示類別 */
        body.mode-creator #creator-ui { display: flex; }
        body.mode-share #player-container { display: block; }
        body.mode-share #floating-share { display: block; }

    </style>
</head>
<body class="mode-creator">

    <!-- 創作者模式：輸入網址 -->
    <div id="creator-ui">
        <h1>Music Curator</h1>
        <div class="input-group">
            <input type="text" id="music-input" placeholder="PASTE PATH OR URL" autocomplete="off">
            <button onclick="generateAndCopy()">GENERATE & COPY LINK</button>
        </div>
    </div>

    <!-- 分享模式：全螢幕播放 -->
    <div id="player-container">
        <div id="player-mount"></div>
    </div>

    <button id="floating-share" onclick="copyCurrentUrl()">Copy Link</button>

    <script>
        const body = document.body;
        const input = document.getElementById('music-input');
        const mount = document.getElementById('player-mount');

        // 1. 初始化檢查：如果有參數，直接進入分享模式
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const m = params.get('m');
            if (m) {
                showPlayer(m);
            } else {
                body.className = 'mode-creator';
            }
        };

        // 2. 顯示播放器邏輯
        function showPlayer(pathData) {
            body.className = 'mode-share';
            
            // 解析路徑
            let path = "";
            if (pathData.includes('music.apple.com')) {
                const url = new URL(pathData);
                path = url.pathname + url.search;
            } else {
                path = pathData.startsWith('/') ? pathData : '/' + pathData;
            }

            const embedUrl = `https://embed.music.apple.com${path}`;
            
            // 判斷是否為歌單以優化顯示
            // 注意：Apple Music 嵌入在寬度足夠時會自動填滿，高度則由 iframe 定義
            mount.innerHTML = `
                <iframe 
                    allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write" 
                    sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" 
                    src="${embedUrl}">
                </iframe>
            `;
        }

        // 3. 產生連結並自動複製
        function generateAndCopy() {
            const val = input.value.trim();
            if (!val) return;

            let path = "";
            try {
                if (val.includes('music.apple.com')) {
                    const url = new URL(val);
                    path = url.pathname + url.search;
                } else {
                    path = val.startsWith('/') ? val : '/' + val;
                }
            } catch (e) { path = val; }

            // 構造分享連結
            const shareUrl = window.location.origin + window.location.pathname + '?m=' + encodeURIComponent(path);
            
            // 複製到剪貼簿
            navigator.clipboard.writeText(shareUrl).then(() => {
                const originalBtnText = document.querySelector('button').innerText;
                document.querySelector('button').innerText = 'COPIED TO CLIPBOARD';
                setTimeout(() => {
                    // 創作者點擊後也可以直接切換到預覽模式
                    window.location.href = shareUrl;
                }, 800);
            });
        }

        function copyCurrentUrl() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const btn = document.getElementById('floating-share');
                btn.innerText = 'COPIED';
                setTimeout(() => btn.innerText = 'COPY LINK', 2000);
            });
        }

        // 監聽 Enter 鍵
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") generateAndCopy();
        });
    </script>
</body>
</html>
