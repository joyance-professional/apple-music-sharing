<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Share</title>
    <!-- 預設的 Open Graph (靜態) -->
    <meta property="og:title" content="Music Curator">
    <meta property="og:description" content="分享我的音樂品味">
    
    <style>
        :root { --bg: #ffffff; --text: #000000; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            overflow-x: hidden;
        }

        /* 背景模糊封面 - 增加氛圍感 */
        #bg-blur {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(60px) opacity(0.2);
            z-index: -1;
            transition: background-image 1s ease;
        }

        /* 創作者模式 */
        #creator-ui {
            display: flex; height: 100vh; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; transition: 0.5s;
        }
        .input-box {
            width: 100%; max-width: 400px; text-align: center;
        }
        h1.logo { font-size: 12px; letter-spacing: 5px; margin-bottom: 50px; opacity: 0.5; }
        input {
            width: 100%; border: none; border-bottom: 1px solid #000; padding: 15px;
            font-size: 16px; outline: none; text-align: center; margin-bottom: 30px;
        }
        button {
            background: #000; color: #fff; border: none; padding: 12px 40px;
            font-size: 11px; letter-spacing: 2px; cursor: pointer;
        }

        /* 分享展示模式 */
        #share-ui {
            display: none; min-height: 100vh; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px 20px; text-align: center;
        }
        #art-preview {
            width: 280px; height: 280px; border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            margin-bottom: 30px; background-size: cover;
            animation: slideUp 1s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #music-title {
            font-size: 24px; font-weight: 700; margin-bottom: 5px;
            animation: slideUp 1.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #music-subtitle {
            font-size: 16px; opacity: 0.5; margin-bottom: 40px;
            animation: slideUp 1.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .player-wrap {
            width: 100%; max-width: 600px;
            animation: slideUp 1.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        footer { position: fixed; bottom: 30px; width: 100%; text-align: center; font-size: 10px; opacity: 0.3; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div id="bg-blur"></div>

    <!-- 模式 1: 生成頁面 -->
    <div id="creator-ui">
        <h1 class="logo">MUSIC SHARE</h1>
        <div class="input-box">
            <input type="text" id="url-input" placeholder="貼上 Apple Music 連結">
            <button onclick="generate()">GENERATE LINK</button>
        </div>
    </div>

    <!-- 模式 2: 展示頁面 -->
    <div id="share-ui">
        <div id="art-preview"></div>
        <h2 id="music-title">Loading...</h2>
        <p id="music-subtitle"></p>
        <div class="player-wrap" id="player-mount"></div>
    </div>

    <footer id="footer-text">MINIMALIST CURATOR</footer>

    <script>
        const params = new URLSearchParams(window.location.search);
        const mPath = params.get('m');

        if (mPath) {
            loadSharePage(mPath);
        }

        async function loadSharePage(path) {
            document.getElementById('creator-ui').style.display = 'none';
            document.getElementById('share-ui').style.display = 'flex';
            
            // 嘗試從路徑解析 ID 並獲取資料 (使用 corsproxy 抓取預覽資訊)
            const fullUrl = `https://music.apple.com${path}`;
            
            try {
                // 這裡使用一個公共的 CORS 代理來抓取 Apple Music 的 Meta 標籤
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(fullUrl)}`);
                const data = await res.json();
                const html = data.contents;
                
                // 解析標題與圖片
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const title = doc.querySelector('meta[property="og:title"]')?.content || "Unknown Song";
                const image = doc.querySelector('meta[property="og:image"]')?.content || "";
                const artist = doc.querySelector('meta[name="description"]')?.content.split('歌曲')[0] || "";

                // 更新 UI
                document.getElementById('music-title').innerText = title.split(' - ')[0];
                document.getElementById('music-subtitle').innerText = artist;
                document.getElementById('art-preview').style.backgroundImage = `url(${image})`;
                document.getElementById('bg-blur').style.backgroundImage = `url(${image})`;
                document.title = `${title} | Music Share`;
            } catch (e) {
                document.getElementById('music-title').innerText = "Music Shared";
            }

            // 載入播放器
            const isCollection = path.includes('playlist') || (path.includes('album') && !path.includes('?i='));
            const height = isCollection ? "450px" : "175px";
            document.getElementById('player-mount').innerHTML = `
                <iframe allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write" 
                style="width:100%; height:${height}; border:none; border-radius:12px; background:transparent;" 
                src="https://embed.music.apple.com${path}"></iframe>`;
        }

        function generate() {
            const input = document.getElementById('url-input').value;
            if(!input) return;
            const url = new URL(input);
            const path = url.pathname + url.search;
            const finalLink = window.location.origin + window.location.pathname + '?m=' + encodeURIComponent(path);
            
            navigator.clipboard.writeText(finalLink).then(() => {
                alert('連結已產生並複製！');
                window.location.href = finalLink;
            });
        }
    </script>
</body>
</html>
